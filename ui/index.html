<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title> RAG Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 1100px; }
    textarea { width: 100%; height: 90px; }
    button { margin: 8px 0; padding: 10px 14px; cursor: pointer; }
    .row { display: flex; gap: 16px; }
    .col { flex: 1; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 10px 0; }
    .meta { font-size: 12px; color: #444; margin-bottom: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; }
    .answer { white-space: pre-wrap; background: #fafafa; }
    .muted { color: #777; font-size: 13px; }
  </style>
</head>
<body>
  <h2>RAG — Demo (question → chunks → answer)</h2>

  <textarea id="question" placeholder="Например: Кто совершил убийство, которое спровоцировало Первую мировую войну?"></textarea>
  <br/>

  <button id="btnSearch">To answer the question</button>

  <div class="row">
    <div class="col">
      <h3>Предложенные чанки</h3>
      <div id="candidates"></div>
    </div>
    <div class="col">
      <h3>Ответ</h3>
      <div id="answer" class="card answer">Пока нет ответа.</div>
      <div id="selected"></div>
    </div>
  </div>

<script>
const API = "http://127.0.0.1:8000";

let lastCandidates = [];

function escapeHtml(s) {
  return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function renderCandidates(cands) {
  const root = document.getElementById("candidates");
  root.innerHTML = "";
  cands.forEach((c, idx) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
  <b>#${idx+1}</b>
  <div class="meta">
    <span class="mono">chunk_id: ${escapeHtml(c.chunk_id)}</span>
  </div>
  <div><b>${escapeHtml(c.title || "")}</b></div>
  <div>${escapeHtml((c.text || "").slice(0, 900))}${(c.text||"").length>900 ? "..." : ""}</div>
`;
    root.appendChild(div);
  });
}

function getSelectedChunkIds() {
  return Array.from(document.querySelectorAll(".chk"))
    .filter(x => x.checked)
    .map(x => x.getAttribute("data-id"));
}

async function onRAG() {
  const q = document.getElementById("question").value.trim();
  if (!q) return;

  document.getElementById("answer").innerText = "Ищу ответ...";
  document.getElementById("candidates").innerHTML = "";

  const resp = await fetch(`${API}/rag`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({question: q})
  });

  const data = await resp.json();

  document.getElementById("answer").innerText =
    data.answer || "Нет ответа.";

  renderCandidates(data.candidates || []);
}


document.getElementById("btnSearch").addEventListener("click", onRAG);
</script>
</body>
</html>
